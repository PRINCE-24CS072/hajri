<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OCR Tuning Guide - Hajri</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container { max-width: 1400px; margin: 0 auto; }
        .header {
            background: white;
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        h1 { color: #667eea; margin-bottom: 8px; }
        h2 { color: #333; margin-bottom: 16px; font-size: 20px; }
        h3 { color: #667eea; margin: 16px 0 8px; font-size: 16px; }
        .subtitle { color: #666; }
        .grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; }
        .card {
            background: white;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .preset {
            border: 3px solid #ddd;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 16px;
            cursor: pointer;
            transition: all 0.3s;
        }
        .preset:hover {
            border-color: #667eea;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.2);
        }
        .preset.active {
            border-color: #667eea;
            background: #f0f4ff;
        }
        .preset-title {
            font-size: 20px;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 8px;
        }
        .preset-speed {
            font-size: 16px;
            color: #666;
            margin-bottom: 12px;
        }
        .param {
            background: #f5f7fa;
            padding: 8px 12px;
            border-radius: 6px;
            margin: 4px 0;
            font-family: 'Courier New', monospace;
            font-size: 13px;
        }
        .param-name { color: #667eea; font-weight: bold; }
        .param-value { color: #333; }
        .tips {
            background: #fff3cd;
            padding: 16px;
            border-radius: 8px;
            margin-top: 16px;
        }
        .tips h3 { color: #856404; margin-bottom: 8px; }
        .tips li { margin: 6px 0; color: #856404; line-height: 1.5; }
        .warning {
            background: #f8d7da;
            color: #721c24;
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 16px;
        }
        .success {
            background: #d4edda;
            color: #155724;
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 16px;
        }
        .code-block {
            background: #2d2d2d;
            color: #f8f8f2;
            padding: 16px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            overflow-x: auto;
            margin: 16px 0;
        }
        .code-block .comment { color: #75715e; }
        .code-block .string { color: #e6db74; }
        .code-block .number { color: #ae81ff; }
        .code-block .keyword { color: #66d9ef; }
        .btn {
            display: inline-block;
            padding: 12px 24px;
            margin: 8px 8px 8px 0;
            border: none;
            border-radius: 8px;
            background: #667eea;
            color: white;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            text-decoration: none;
            transition: all 0.3s;
        }
        .btn:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }
        .btn-secondary {
            background: #6c757d;
        }
        .btn-secondary:hover {
            background: #5a6268;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 16px 0;
        }
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        th {
            background: #f5f7fa;
            font-weight: 600;
            color: #667eea;
        }
        .slider-container {
            margin: 20px 0;
        }
        .slider-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-weight: 500;
        }
        .slider-value {
            color: #667eea;
            font-weight: bold;
            font-size: 18px;
        }
        input[type="range"] {
            width: 100%;
            height: 8px;
            border-radius: 4px;
            background: #ddd;
            outline: none;
            margin: 8px 0;
        }
        input[type="range"]::-webkit-slider-thumb {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: #667eea;
            cursor: pointer;
        }
        .copy-btn {
            background: #28a745;
            font-size: 12px;
            padding: 6px 12px;
            margin-left: 8px;
        }
        @media (max-width: 1024px) {
            .grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üéØ Hajri OCR - Interactive Tuning Guide</h1>
            <p class="subtitle">Adjust settings in table_extractor.py to optimize speed vs accuracy</p>
        </div>

        <div class="warning">
            <strong>‚ö†Ô∏è Current Issue:</strong> OCR is taking too long (~10+ seconds per image)
            <br>This happens because PaddleOCR's default settings are optimized for accuracy, not speed.
        </div>

        <h2 style="color: white; margin-bottom: 16px;">üöÄ Choose Your Performance Preset:</h2>

        <div class="grid">
            <!-- FAST Preset -->
            <div class="preset" onclick="selectPreset(1)">
                <div class="preset-title">‚ö° FAST</div>
                <div class="preset-speed">~1-2 seconds per image</div>
                <div class="param"><span class="param-name">use_angle_cls:</span> <span class="param-value">False</span></div>
                <div class="param"><span class="param-name">det_limit_side_len:</span> <span class="param-value">640</span></div>
                <div class="param"><span class="param-name">max_image_size:</span> <span class="param-value">960</span></div>
                <div class="param"><span class="param-name">drop_score:</span> <span class="param-value">0.35</span></div>
                <div class="param"><span class="param-name">min_confidence:</span> <span class="param-value">35</span></div>
                <div class="param"><span class="param-name">cpu_threads:</span> <span class="param-value">4</span></div>
            </div>

            <!-- BALANCED Preset -->
            <div class="preset active" onclick="selectPreset(2)">
                <div class="preset-title">‚öñÔ∏è BALANCED (Recommended)</div>
                <div class="preset-speed">~2-4 seconds per image</div>
                <div class="param"><span class="param-name">use_angle_cls:</span> <span class="param-value">False</span></div>
                <div class="param"><span class="param-name">det_limit_side_len:</span> <span class="param-value">960</span></div>
                <div class="param"><span class="param-name">max_image_size:</span> <span class="param-value">1280</span></div>
                <div class="param"><span class="param-name">drop_score:</span> <span class="param-value">0.30</span></div>
                <div class="param"><span class="param-name">min_confidence:</span> <span class="param-value">40</span></div>
                <div class="param"><span class="param-name">cpu_threads:</span> <span class="param-value">4</span></div>
            </div>

            <!-- ACCURATE Preset -->
            <div class="preset" onclick="selectPreset(3)">
                <div class="preset-title">üéØ ACCURATE</div>
                <div class="preset-speed">~4-8 seconds per image</div>
                <div class="param"><span class="param-name">use_angle_cls:</span> <span class="param-value">True</span></div>
                <div class="param"><span class="param-name">det_limit_side_len:</span> <span class="param-value">1280</span></div>
                <div class="param"><span class="param-name">max_image_size:</span> <span class="param-value">1920</span></div>
                <div class="param"><span class="param-name">drop_score:</span> <span class="param-value">0.25</span></div>
                <div class="param"><span class="param-name">min_confidence:</span> <span class="param-value">45</span></div>
                <div class="param"><span class="param-name">cpu_threads:</span> <span class="param-value">6</span></div>
            </div>
        </div>

        <!-- Code to Copy -->
        <div class="card" style="margin-top: 20px;">
            <h2>üìù Copy This Code to table_extractor.py</h2>
            <p style="margin-bottom: 16px; color: #666;">Replace the <code>__init__</code> method in the TableExtractor class:</p>
            
            <div id="code-display" class="code-block">
<span class="keyword">def</span> __init__(<span class="keyword">self</span>, use_gpu: <span class="keyword">bool</span> = <span class="keyword">False</span>, config: Optional[Dict] = <span class="keyword">None</span>):
    <span class="comment">"""Initialize OCR engines with BALANCED preset (recommended)"""</span>
    default_config = {
        <span class="string">'use_angle_cls'</span>: <span class="keyword">False</span>,  <span class="comment"># Disabled for 30-40% speed boost</span>
        <span class="string">'lang'</span>: <span class="string">'en'</span>,
        <span class="string">'use_gpu'</span>: use_gpu,
        <span class="string">'show_log'</span>: <span class="keyword">False</span>,
        <span class="string">'det_limit_side_len'</span>: <span class="number">960</span>,  <span class="comment"># Detection input size (640=fast, 960=balanced, 1280=accurate)</span>
        <span class="string">'det_db_thresh'</span>: <span class="number">0.3</span>,
        <span class="string">'det_db_box_thresh'</span>: <span class="number">0.5</span>,
        <span class="string">'rec_batch_num'</span>: <span class="number">6</span>,
        <span class="string">'drop_score'</span>: <span class="number">0.3</span>,  <span class="comment"># Min confidence (lower = keep more text)</span>
        <span class="string">'cpu_threads'</span>: <span class="number">4</span>,
        <span class="string">'enable_mkldnn'</span>: <span class="keyword">False</span>
    }
    
    <span class="keyword">if</span> config:
        default_config.update(config)
    
    <span class="keyword">self</span>.paddle_ocr = PaddleOCR(**default_config)
    <span class="keyword">self</span>.current_config = default_config
    <span class="keyword">self</span>.table_ocr = TablePaddleOCR(lang=<span class="string">'en'</span>)
    <span class="keyword">self</span>.table_min_confidence = config.get(<span class="string">'min_confidence'</span>, <span class="number">40</span>) <span class="keyword">if</span> config <span class="keyword">else</span> <span class="number">40</span>
            </div>
            
            <button class="btn" onclick="copyCode()">üìã Copy Code</button>
            <button class="btn btn-secondary" onclick="window.open('vscode://file/b:/hajri/hajri-ocr/table_extractor.py')">üìÇ Open table_extractor.py</button>
        </div>

        <!-- Interactive Sliders -->
        <div class="card" style="margin-top: 20px;">
            <h2>üéõÔ∏è Custom Tuning (Advanced)</h2>
            <p style="margin-bottom: 16px; color: #666;">Adjust these sliders to create your own configuration:</p>

            <div class="slider-container">
                <div class="slider-label">
                    <span>Detection Image Size</span>
                    <span class="slider-value" id="val-det">960</span>
                </div>
                <input type="range" id="slider-det" min="640" max="1920" step="320" value="960" oninput="updateSlider()">
                <small>Lower = faster processing | Higher = more accurate text detection</small>
            </div>

            <div class="slider-container">
                <div class="slider-label">
                    <span>Confidence Threshold</span>
                    <span class="slider-value" id="val-conf">0.30</span>
                </div>
                <input type="range" id="slider-conf" min="0.20" max="0.70" step="0.05" value="0.30" oninput="updateSlider()">
                <small>Lower = keep more text | Higher = only high confidence text</small>
            </div>

            <div class="slider-container">
                <div class="slider-label">
                    <span>Table Detection Threshold</span>
                    <span class="slider-value" id="val-table">40</span>
                </div>
                <input type="range" id="slider-table" min="30" max="70" step="5" value="40" oninput="updateSlider()">
                <small>Lower = find more tables | Higher = only clear tables</small>
            </div>

            <div class="slider-container">
                <div class="slider-label">
                    <span>CPU Threads</span>
                    <span class="slider-value" id="val-threads">4</span>
                </div>
                <input type="range" id="slider-threads" min="2" max="8" step="1" value="4" oninput="updateSlider()">
                <small>More threads can be faster (if you have the CPU cores)</small>
            </div>

            <div style="margin: 20px 0;">
                <label style="display: flex; align-items: center; cursor: pointer;">
                    <input type="checkbox" id="check-angle" onchange="updateSlider()" style="width: 20px; height: 20px; margin-right: 12px;">
                    <span>Enable Angle Detection (slower, usually not needed for dashboards)</span>
                </label>
            </div>

            <button class="btn" onclick="generateCustomCode()">üîß Generate Custom Code</button>
        </div>

        <!-- Tuning Guide -->
        <div class="card" style="margin-top: 20px;">
            <h2>üìö Parameter Guide</h2>
            
            <table>
                <thead>
                    <tr>
                        <th>Parameter</th>
                        <th>What It Does</th>
                        <th>Speed Impact</th>
                        <th>Recommended</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><code>use_angle_cls</code></td>
                        <td>Detect and rotate angled text</td>
                        <td>‚ùå‚ùå Very Slow (+30-40%)</td>
                        <td><strong>False</strong> (dashboards are straight)</td>
                    </tr>
                    <tr>
                        <td><code>det_limit_side_len</code></td>
                        <td>Max image dimension for detection</td>
                        <td>‚ùå Slow (higher = slower)</td>
                        <td><strong>640-960</strong> for speed</td>
                    </tr>
                    <tr>
                        <td><code>drop_score</code></td>
                        <td>Minimum confidence to keep text</td>
                        <td>‚úÖ No impact</td>
                        <td><strong>0.25-0.35</strong> for attendance data</td>
                    </tr>
                    <tr>
                        <td><code>min_confidence</code></td>
                        <td>Table detection threshold</td>
                        <td>‚úÖ No impact</td>
                        <td><strong>35-45</strong> for dashboard tables</td>
                    </tr>
                    <tr>
                        <td><code>cpu_threads</code></td>
                        <td>Number of CPU threads to use</td>
                        <td>‚úÖ Faster (if CPU allows)</td>
                        <td><strong>4-6</strong> for most systems</td>
                    </tr>
                    <tr>
                        <td><code>rec_batch_num</code></td>
                        <td>Recognition batch size</td>
                        <td>‚úÖ Slightly faster (higher)</td>
                        <td><strong>6-8</strong> for balanced</td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- Quick Tips -->
        <div class="card" style="margin-top: 20px;">
            <div class="tips">
                <h3>üí° Quick Tips to Speed Up OCR</h3>
                <ul>
                    <li><strong>Biggest speedup:</strong> Set <code>use_angle_cls=False</code> (saves 30-40% time)</li>
                    <li><strong>For testing:</strong> Use <code>det_limit_side_len=640</code> (fastest)</li>
                    <li><strong>Missing text?</strong> Lower <code>drop_score</code> to 0.25 or 0.20</li>
                    <li><strong>"No table found"?</strong> Lower <code>min_confidence</code> to 35 or 30</li>
                    <li><strong>Still slow?</strong> Reduce image size before uploading (resize to 1280px width)</li>
                    <li><strong>Production:</strong> Use BALANCED preset - best speed/accuracy tradeoff</li>
                </ul>
            </div>
        </div>

        <!-- Test Instructions -->
        <div class="card" style="margin-top: 20px;">
            <h2>üß™ How to Test Your Changes</h2>
            <ol style="line-height: 2;">
                <li>Click a preset above or adjust sliders</li>
                <li>Click "Copy Code" button</li>
                <li>Open <code>table_extractor.py</code> in VS Code</li>
                <li>Replace the <code>__init__</code> method with the copied code</li>
                <li>Server will auto-reload (uvicorn --reload)</li>
                <li>Test with: <code>curl.exe -X POST "http://localhost:8000/ocr/extract" -F "file=@test_images/Screenshot 2025-12-16 170421.png"</code></li>
                <li>Check processing time in the response</li>
            </ol>
        </div>
    </div>

    <script>
        let currentPreset = 2; // Default to BALANCED

        function selectPreset(preset) {
            currentPreset = preset;
            document.querySelectorAll('.preset').forEach((el, idx) => {
                el.classList.toggle('active', idx + 1 === preset);
            });

            // Update sliders based on preset
            const presets = {
                1: { det: 640, conf: 0.35, table: 35, threads: 4, angle: false },
                2: { det: 960, conf: 0.30, table: 40, threads: 4, angle: false },
                3: { det: 1280, conf: 0.25, table: 45, threads: 6, angle: true }
            };

            const p = presets[preset];
            document.getElementById('slider-det').value = p.det;
            document.getElementById('slider-conf').value = p.conf;
            document.getElementById('slider-table').value = p.table;
            document.getElementById('slider-threads').value = p.threads;
            document.getElementById('check-angle').checked = p.angle;
            updateSlider();
        }

        function updateSlider() {
            document.getElementById('val-det').textContent = document.getElementById('slider-det').value;
            document.getElementById('val-conf').textContent = parseFloat(document.getElementById('slider-conf').value).toFixed(2);
            document.getElementById('val-table').textContent = document.getElementById('slider-table').value;
            document.getElementById('val-threads').textContent = document.getElementById('slider-threads').value;
        }

        function copyCode() {
            const code = document.getElementById('code-display').innerText;
            navigator.clipboard.writeText(code).then(() => {
                alert('‚úÖ Code copied! Now paste it into table_extractor.py');
            });
        }

        function generateCustomCode() {
            const det = document.getElementById('slider-det').value;
            const conf = parseFloat(document.getElementById('slider-conf').value).toFixed(2);
            const table = document.getElementById('slider-table').value;
            const threads = document.getElementById('slider-threads').value;
            const angle = document.getElementById('check-angle').checked;

            const code = `def __init__(self, use_gpu: bool = False, config: Optional[Dict] = None):
    """Initialize OCR engines with custom settings"""
    default_config = {
        'use_angle_cls': ${angle},
        'lang': 'en',
        'use_gpu': use_gpu,
        'show_log': False,
        'det_limit_side_len': ${det},
        'det_db_thresh': 0.3,
        'det_db_box_thresh': 0.5,
        'rec_batch_num': 6,
        'drop_score': ${conf},
        'cpu_threads': ${threads},
        'enable_mkldnn': False
    }
    
    if config:
        default_config.update(config)
    
    self.paddle_ocr = PaddleOCR(**default_config)
    self.current_config = default_config
    self.table_ocr = TablePaddleOCR(lang='en')
    self.table_min_confidence = config.get('min_confidence', ${table}) if config else ${table}`;

            document.getElementById('code-display').innerHTML = code
                .replace(/def|self|bool|False|True|None|if|else/g, '<span class="keyword">$&</span>')
                .replace(/('.*?')/g, '<span class="string">$1</span>')
                .replace(/(\d+)/g, '<span class="number">$1</span>')
                .replace(/(#.*$)/gm, '<span class="comment">$1</span>');

            alert('‚úÖ Custom code generated! Click "Copy Code" to copy it.');
        }
    </script>
</body>
</html>
